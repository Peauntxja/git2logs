# 工时分配功能更新说明

## 更新时间
2026-01-28

## 问题修复

### 1. ✅ 修复代码变更量统计为0的问题

**原因分析**:
- GitLab API返回的stats数据结构在不同版本中有所不同
- 原代码只处理了一种数据结构，导致部分情况下无法正确获取统计数据

**解决方案**:
- 实现多种数据获取方式，兼容不同的API返回格式
- 尝试从`commit.stats.total`（字典或对象）获取
- 尝试从`commit.stats`直接获取
- 备用方案：从result中的commits详情获取

**改进效果**:
```python
# 现在支持多种数据格式
if isinstance(commit.stats.total, dict):
    additions = commit.stats.total.get('additions', 0)
    deletions = commit.stats.total.get('deletions', 0)
else:
    additions = getattr(commit.stats.total, 'additions', 0) or 0
    deletions = getattr(commit.stats.total, 'deletions', 0) or 0
```

## 新增功能

### 2. ✅ 增加GitLab信息列

在工时分配表中新增三列：

#### 新增列说明

| 列名 | 说明 | 示例 |
|-----|------|-----|
| **Commit ID** | 提交的短ID（前8位） | abc123de |
| **分支** | 提交所在的分支 | main / develop |
| **GitLab地址** | 可点击的链接 | [查看](链接) |

#### 代码变更显示优化

- **原格式**: `150` （只显示总数）
- **新格式**: `+120 -30` （显示新增和删除）

#### 示例表格

```markdown
| 项目名称 | 任务名称 | 任务类型 | 工时(h) | 代码变更 | Commit ID | 分支 | GitLab地址 |
|---------|---------|---------|--------|----------|-----------|------|----------|
| **project** (5.5h) | feat: 新功能 | 功能开发 | 3.25 | +120 -30 | abc123de | main | [查看](链接) |
```

### 3. ✅ 添加独立工时报告功能

#### 命令行使用

```bash
# 生成单日工时报告
python git2logs.py --author "作者名" \
  --since 2026-01-28 \
  --until 2026-01-28 \
  --work-hours

# 生成周工时报告
python git2logs.py --author "作者名" \
  --since 2026-01-21 \
  --until 2026-01-28 \
  --work-hours

# 自定义每日工时
python git2logs.py --author "作者名" \
  --today \
  --work-hours \
  --daily-hours 7.5
```

#### 图形界面使用

在"输出格式"中选择：
- **工时分配报告 (详细工时统计)**

#### 报告内容

**单日报告包含**:
- 工时概览（工作天数、总工时、日均工时、任务数）
- 项目工时分布表（总工时、占比、任务数）
- 详细工时分配表（每个任务的详细信息）

**多日报告包含**:
- 工时概览
- 项目工时分布汇总
- 按日期分组的每日工时明细

#### 示例输出

```markdown
# 张三 - 工时分配报告
**生成时间**: 2026-01-28 10:47:15
**提交者**: 张三
**统计时间**: 2026年01月28日 (2026-01-28)
**标准工时**: 8.0 小时/天

---

## 📊 工时概览

- **工作天数**: 1 天
- **总工时**: 8.0 小时
- **日均工时**: 8.0 小时
- **总任务数**: 3 个

---

## 📦 项目工时分布

| 项目名称 | 总工时(小时) | 占比 | 任务数 |
|---------|------------|------|-------|
| project-1 | 5.5 | 69.1% | 2 |
| project-2 | 2.5 | 30.9% | 1 |

---

## ⏱️ 工时分配表

| 项目名称 | 任务名称 | 任务类型 | 工时(h) | 代码变更 | Commit ID | 分支 | GitLab地址 |
|---------|---------|---------|--------|----------|-----------|------|----------|
| **project-1** (5.5h) | feat: 新功能 | 功能开发 | 3.25 | +120 -30 | abc123de | main | [查看](链接) |
| | fix: 修复bug | Bug修复 | 0.91 | +20 -10 | def456gh | main | [查看](链接) |
```

## 技术实现

### 新增函数

1. **`generate_work_hours_report()`**
   - 专门生成工时分配报告
   - 支持单日和多日报告
   - 包含工时概览、项目分布、详细明细

2. **改进的 `calculate_work_hours()`**
   - 增强的代码统计获取逻辑
   - 收集GitLab地址、分支、commitid信息
   - 支持多种stats数据格式

3. **改进的 `format_work_hours_table()`**
   - 新增三列：Commit ID、分支、GitLab地址
   - 代码变更显示格式：`+additions -deletions`
   - 支持可点击的GitLab链接

### GUI集成

在CustomTkinter界面中：
- 新增"工时分配报告"选项
- 自动生成 `YYYY-MM-DD_work_hours.md` 文件
- 支持目录选择和文件名自定义

## 测试验证

### 测试用例

✅ 代码变更量统计正确
✅ GitLab信息列正确显示
✅ 工时计算算法正确
✅ 单日报告格式正确
✅ 多日报告格式正确
✅ 命令行参数正常工作
✅ GUI界面选项正常工作

### 测试结果

```
============================================================
✅ 所有测试通过！
============================================================
```

## 文件修改

### 修改的文件

1. **git2logs.py**
   - 修改: `calculate_work_hours()` - 改进统计获取逻辑
   - 修改: `format_work_hours_table()` - 增加新列
   - 新增: `generate_work_hours_report()` - 独立报告生成
   - 新增: 命令行参数 `--work-hours` 和 `--daily-hours`

2. **git2logs_gui_ctk.py**
   - 修改: 输出格式选项列表
   - 修改: 报告生成逻辑
   - 新增: 工时报告选项

### 新增的文件

- `test_work_hours_update.py` - 测试脚本
- `test_work_hours_report.md` - 测试报告示例

## 使用场景

### 1. 日常工时统计
每天下班前生成当天的工时报告，了解时间分配情况。

### 2. 周报/月报准备
生成周或月的工时报告，快速整理工作内容和时间投入。

### 3. 项目工时分析
分析不同项目的工时占比，优化资源分配。

### 4. 任务时间追踪
通过commit记录自动生成任务级别的时间统计。

## 注意事项

### 工时计算说明

1. **算法基础**
   - 基于代码变更量、提交频率、文件数的启发式算法
   - 不是精确的时间追踪，仅供参考

2. **默认配置**
   - 每日标准工时：8小时
   - 可通过 `--daily-hours` 参数自定义

3. **权重分配**
   - 代码变更量：60%
   - 提交频率：20%
   - 文件变更数：20%

### 数据要求

1. **GitLab API**
   - 需要有读取权限
   - stats数据可能需要额外的API权限
   - 如果stats不可用，代码变更量可能为0

2. **分支信息**
   - 需要GitLab API返回refs信息
   - 如果不可用，分支列显示为空

## 后续优化建议

1. **分支信息获取**
   - 改进分支信息的获取方式
   - 支持从commit message中提取分支信息

2. **工时算法优化**
   - 考虑提交时间分布
   - 支持自定义权重配置

3. **报告格式扩展**
   - 支持Excel格式导出
   - 添加图表展示

4. **历史数据对比**
   - 支持多周期工时对比
   - 趋势分析

---

## 更新完成清单

- [x] 修复代码变更量统计问题
- [x] 增加GitLab信息列（地址、分支、commitid）
- [x] 添加独立工时报告生成函数
- [x] 添加命令行参数支持
- [x] 更新GUI界面选项
- [x] 编写测试脚本
- [x] 运行验证测试
- [x] 编写更新文档

所有功能已完成并通过测试！
